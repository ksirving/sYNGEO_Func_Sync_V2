---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# sYNGEO_Func_Sync_V2

# Code index

1. 01_single_traits_interpolated_abundances_new_cwm.R
1. 02a_sync_trait_ord_groups_eff_resp_interpolated.R
1. 02b_sync_single_traits_groups_eff_resp_interpolated.R
1. 03a_dummy_connectivity_variable_interpolated.R
1. 04_differences_in_synchrony.R
1. 05a_figures_single_traits.R
1. 05b_figures_ordination.R


# 01_single_traits_interpolated_abundances_new_cwm.R

Takes raw abundance data and traits for each species
cleans and interpolates abundances. 
Produces CWMs and CMVs (interpolated) for all traits and groups


### output_data from scripts 02a & 02b & 3a & 3b are saved into output_data/sync under .gitignore

# 02a_sync_trait_ord_groups_eff_resp_interpolated.R

calculates synchrony with ordination scores
within site, between site, jackknife (leaving one year out)


# 02b_sync_single_traits_groups_eff_resp_interpolated.R

calculates synchrony for single traits
within site, between site, jackknife (leaving one year out)
also includes synchrony calculation for temperature and flow

## 03a_dummy_connectivity_variable_interpolated.R

calculates distances and connectivity variable
joins to all synchrony datasets
join on water course distance for testing

## 04_differences_in_synchrony.R

calculates the differences in synchrony from the calculation of sync using all years and the jack knife leave one out (LOO)
some NAs in df, from where correaltion couldn't be calculated in scrip 02a/b

## 05a_figures_single_traits.R

create figures for single trait synchrony and env variables. for overall synchrony and contribution of years (leave one out, LOO)

## 05b_figures_ordination.R

create figures for ordination synchrony and env variables. for overall synchrony and contribution of years (leave one out, LOO)
also includes temp and flow LOO figures


# Computation:

## CWM and Variance

```{r}
devtools::install_github("alaindanet/ecocom")
library(ecocom)

#vector of species abundance
abun <- rpois(n = 10, lambda = 3)
# vector of species trait
trait <- rnorm(n = 10, mean = 10, sd = 3)

# Compute the moments of trait distribution
calc_cw_moments(trait = trait, weight = abun)

# 
calc_cw_mean(trait = trait, weight = abun)
calc_cw_variance(trait = trait, weight = abun)
```

## Synchrony

Source the function at the beginning of your script:
```{r}
source("https://raw.githubusercontent.com/alaindanet/fishcom/master/R/synchrony.R")

sync_mat <- matrix(
  c(0, 0, 1, 1),
  nrow = 2,
  byrow = TRUE,
  dimnames = list(
    paste0("t", c(1, 2)),
    c("sp1", "sp2")
  )
)

# Complete synchrony
sync_mat
compute_synchrony(cov(sync_mat))

# Complete asynchrony
async_mat <- sync_mat
async_mat[, 1] <- rev(async_mat[, 1])
compute_synchrony(cov(async_mat))
```

# Temperature data

## Moving average over 12 months

See [doc/b-temperature.html](https://github.com/ksirving/sYNGEO_Func_Sync_V2/blob/main/doc/b-temperature.html)

```{r}
library(tidyverse)
sites_water_air_tmean_av <- read_csv(
  here::here("input_data", "Env", "sites_water_air_tmean_av.csv")
)
```

